/*
 * kernel.h
 *
 *  Created on: Sep 11, 2016
 *      Author: KSSKOU001: Hermann
 */

#ifndef KERNEL_H_
#define KERNEL_H_

#include "TM38/defines.h"
#include "TM38/tm_stm32f4_disco.h"
#include "TM38/tm_stm32f4_exti.h"

#include "ST080Utils.h"	// this is where the FreeRTOS stuff (functions and variable are too)
#include "composer.h"	//composer mode functionalities
//#include "freestyle.h" //freestyle mode functionalities not yet implemented
//#include "playback.h"  //playback mode functionalities not yet implemented

// define task priorities
#define COMPOSER_TASK_PRIORITY 2
#define PLAYBACK_TASK_PRIORITY 2
#define FREESTYLE_TASK_PRIORITY 2

// define task stack sizes
#define COMPOSER_STACK_SIZE 128
#define PLAYBACK_STACK_SIZE 128
#define FREESTYLE_STACK_SIZE 128

/*
 * FreeRTOS initial configs
 */
void kernelInit(void) {

};


/*
 * Associate 3 GPIO_Pins to Three Interrupts
 * Template Taken from Tino composer
 */
void InterruptConfig(void)
{
	// pins being used for kernel
	// PD0, PD1, PD2
	bool fail = false;
	if (TM_EXTI_Attach(GPIOD, GPIO_Pin_0, TM_EXTI_Trigger_Rising) != TM_EXTI_Result_Ok){
		// PA0
		fail = true;
	} else if (TM_EXTI_Attach(GPIOD, GPIO_Pin_1, TM_EXTI_Trigger_Rising) != TM_EXTI_Result_Ok){
		// PA1
		fail = true;
	} else if (TM_EXTI_Attach(GPIOD, GPIO_Pin_2, TM_EXTI_Trigger_Rising) != TM_EXTI_Result_Ok){
		// PA2
		fail = true;

	if (fail){
		// TODO failed configuring interrupts. (FLASH LEDs or something)
	}

};
static void vKernelTask(void *pvparameters) {

	TaskHandle_t composer_Handle;
	TaskHandle_t playback_Handle;
	TaskHandle_t freestyle_Handle;

	//Create Tasks storing handles
	xTaskCreate(vComposerTask, (signed char * ) "Composer Task", COMPOSER_STACK_SIZE, NULL,
			COMPOSER_TASK_PRIORITY, composer_Handle);

	xTaskCreate(vPlaybackTask, (signed char * ) "Playback Task", PLAYBACK_STACK_SIZE,
						NULL, PLAYBACK_TASK_PRIORITY, playback_Handle);

	xTaskCreate(vFreestyleTask, (signed char * ) "Freestyle Task", FREESTYLE_STACK_SIZE,
				NULL, FREESTYLE_TASK_PRIORITY, freestyle_Handle);

	// Use the handle to suspend the created tasks
	vTaskSuspend(composer_Handle);
	vTaskSuspend(playback_Handle);
	vTaskSuspend(freestyle_Handle);

	InterruptConfig();

	for (;;) {

	}
}

void TM_EXTI_Handler(uint16_t GPIO_Pin) {
//	detach the external interrupt for all GPIO_Pins in used
	TM_EXTI_Detach(GPIO_Pin_0);
	TM_EXTI_Detach(GPIO_Pin_1);
	TM_EXTI_Detach(GPIO_Pin_2);

    /* Handle external line 0 interrupts: The composer mode */
    if (GPIO_Pin == GPIO_Pin_0) {
        /* Toggle RED led */
        TM_DISCO_LedToggle(LED_RED);
        /* Check counter */
        if (++counter >= 10) {
            /* Detach external interrupt for GPIO_Pin_0 no matter on which GPIOx is connected */

        }
    }
}




#endif /* KERNEL_H_ */
